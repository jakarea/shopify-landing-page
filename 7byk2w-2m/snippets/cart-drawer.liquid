{% comment %}
  Cart Drawer - Slide-out cart from right side
{% endcomment %}

<!-- Cart Drawer Overlay -->
<div id="cart-drawer-overlay" class="fixed inset-0 bg-black/50 z-[60] hidden opacity-0 transition-opacity duration-300" aria-hidden="true"></div>

<!-- Cart Drawer -->
<div id="cart-drawer" class="fixed top-0 right-0 h-full w-full sm:w-[480px] bg-white shadow-2xl z-[70] transform translate-x-full transition-transform duration-300 ease-in-out flex flex-col">
  <!-- Cart Header -->
  <div class="flex items-center justify-between px-6 py-4 border-b border-gray-200 bg-gradient-to-r from-purple-600 via-pink-600 to-rose-600">
    <h2 class="text-lg font-bold text-white flex items-center gap-2">
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-shopping-bag w-5 h-5">
        <path d="M6 2 3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4Z"></path>
        <path d="M3 6h18"></path>
        <path d="M16 10a4 4 0 0 1-8 0"></path>
      </svg>
      <span data-i18n="cart.title">Your Cart</span>
      <span id="cart-count-header" class="ml-2 bg-white/20 text-white text-sm font-medium px-2 py-0.5 rounded-full">0</span>
    </h2>
    <button
      type="button"
      id="cart-drawer-close"
      class="p-2 text-white/80 hover:text-white hover:bg-white/20 rounded-lg transition-colors"
      aria-label="Close cart"
    >
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x w-5 h-5">
        <path d="M18 6 6 18"></path>
        <path d="m6 6 12 12"></path>
      </svg>
    </button>
  </div>

  <!-- Cart Items Container -->
  <div id="cart-items-container" class="flex-1 overflow-y-auto">
    <!-- Loading State -->
    <div id="cart-loading-state" class="flex flex-col items-center justify-center h-full px-6 py-12 text-center">
      <div class="w-12 h-12 border-4 border-purple-200 border-t-purple-600 rounded-full animate-spin mb-4"></div>
      <p class="text-gray-500">Loading cart...</p>
    </div>

    <!-- Empty State -->
    <div id="cart-empty-state" class="flex flex-col items-center justify-center h-full px-6 py-12 text-center hidden">
      <div class="w-24 h-24 rounded-full bg-gray-100 flex items-center justify-center mb-6">
        <svg class="w-12 h-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"/>
        </svg>
      </div>
      <h3 class="text-xl font-bold text-gray-900 mb-2" data-i18n="cart.empty_title">Your cart is empty</h3>
      <p class="text-gray-500 mb-6" data-i18n="cart.empty_message">Looks like you haven't added anything yet.</p>
      <button
        type="button"
        id="cart-drawer-close-btn"
        class="inline-flex items-center justify-center gap-2 bg-gradient-to-r from-purple-600 via-pink-600 to-rose-600 hover:from-purple-700 hover:via-pink-700 hover:to-rose-700 text-white font-bold py-3 px-6 rounded-xl shadow-lg hover:shadow-xl transition-all duration-200"
      >
        <span data-i18n="cart.start_shopping">Start Shopping</span>
      </button>
    </div>

    <!-- Cart Items List -->
    <div id="cart-items-list" class="divide-y divide-gray-100 hidden"></div>
  </div>

  <!-- Cart Footer -->
  <div id="cart-footer" class="border-t border-gray-200 bg-gray-50 p-6 hidden">
    <!-- Subtotal -->
    <div class="flex justify-between items-center mb-4">
      <span class="text-gray-600 font-medium" data-i18n="cart.subtotal">Subtotal</span>
      <span id="cart-subtotal" class="text-2xl font-bold text-gray-900">€0.00</span>
    </div>

    <!-- Shipping Note -->
    <p class="text-sm text-gray-500 mb-6" data-i18n="cart.shipping_note">
      Shipping & taxes calculated at checkout
    </p>

    <!-- Checkout Button -->
    <form action="{{ routes.cart_url }}" method="post" id="cart-drawer-form">
      <button
        type="submit"
        name="checkout"
        class="w-full bg-gradient-to-r from-purple-600 via-pink-600 to-rose-600 hover:from-purple-700 hover:via-pink-700 hover:to-rose-700 text-white font-bold py-4 px-6 rounded-xl shadow-lg hover:shadow-xl transition-all duration-200 hover:scale-[1.02] flex items-center justify-center gap-2"
      >
        <span data-i18n="cart.checkout">Checkout</span>
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-arrow-right w-5 h-5">
          <path d="M5 12h14"></path>
          <path d="m12 5 7 7-7 7"></path>
        </svg>
      </button>
    </form>

    <!-- Continue Shopping -->
    <button
      type="button"
      id="cart-drawer-continue"
      class="w-full text-center text-sm text-gray-500 hover:text-purple-600 transition-colors mt-4 flex items-center justify-center gap-1"
    >
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-arrow-left w-4 h-4">
        <path d="m12 19-7-7 7-7"></path>
        <path d="M19 12H5"></path>
      </svg>
      <span data-i18n="cart.continue_shopping">Continue Shopping</span>
    </button>
  </div>
</div>

<style>
  /* Hide scrollbar for cart items but keep functionality */
  #cart-items-container::-webkit-scrollbar {
    width: 6px;
  }
  #cart-items-container::-webkit-scrollbar-track {
    background: #f1f1f1;
  }
  #cart-items-container::-webkit-scrollbar-thumb {
    background: #c1c1c1;
    border-radius: 3px;
  }
  #cart-items-container::-webkit-scrollbar-thumb:hover {
    background: #a1a1a1;
  }

  /* Quantity input styling */
  .cart-quantity-input::-webkit-inner-spin-button,
  .cart-quantity-input::-webkit-outer-spin-button {
    -webkit-appearance: none;
    margin: 0;
  }
  .cart-quantity-input {
    -moz-appearance: textfield;
  }
</style>

<script>
(function() {
    'use strict';

    // Wait for DOM to be ready
    function initCartDrawer() {
        const cartDrawer = document.getElementById('cart-drawer');
        const cartOverlay = document.getElementById('cart-drawer-overlay');
        const cartToggle = document.getElementById('cart-drawer-toggle');
        const cartClose = document.getElementById('cart-drawer-close');
        const cartCloseBtn = document.getElementById('cart-drawer-close-btn');
        const cartContinue = document.getElementById('cart-drawer-continue');
        const cartItemsContainer = document.getElementById('cart-items-container');
        const cartItemsList = document.getElementById('cart-items-list');
        const cartEmptyState = document.getElementById('cart-empty-state');
        const cartLoadingState = document.getElementById('cart-loading-state');
        const cartFooter = document.getElementById('cart-footer');
        const cartCount = document.getElementById('cart-count');
        const cartCountHeader = document.getElementById('cart-count-header');
        const cartSubtotal = document.getElementById('cart-subtotal');

        console.log('=== CART DRAWER: Initializing ===');
        console.log('cartToggle found:', !!cartToggle);
        console.log('cartDrawer found:', !!cartDrawer);
        console.log('cartCount found:', !!cartCount);
        console.log('cartItemsList found:', !!cartItemsList);

        if (!cartDrawer) {
            console.error('Cart drawer element not found!');
            return;
        }

        if (!cartItemsList) {
            console.error('Cart items list element not found!');
            return;
        }

        if (!cartCount) {
            console.warn('Cart count badge not found - will skip count updates');
        }

        let isCartOpen = false;
        let isInitialized = false;

        // Open cart drawer
        function openCartDrawer() {
            isCartOpen = true;
            cartDrawer.classList.remove('translate-x-full');
            cartDrawer.classList.add('translate-x-0');
            if (cartOverlay) {
                cartOverlay.classList.remove('hidden');
                setTimeout(() => cartOverlay.classList.remove('opacity-0'), 10);
            }
            document.body.style.overflow = 'hidden';
            fetchCart();
        }

        // Close cart drawer
        function closeCartDrawer() {
            isCartOpen = false;
            cartDrawer.classList.remove('translate-x-0');
            cartDrawer.classList.add('translate-x-full');
            if (cartOverlay) {
                cartOverlay.classList.add('opacity-0');
                setTimeout(() => cartOverlay.classList.add('hidden'), 300);
            }
            document.body.style.overflow = '';
        }

        // Event listeners
        if (cartToggle) cartToggle.addEventListener('click', openCartDrawer);
        if (cartClose) cartClose.addEventListener('click', closeCartDrawer);
        if (cartCloseBtn) cartCloseBtn.addEventListener('click', closeCartDrawer);
        if (cartContinue) cartContinue.addEventListener('click', closeCartDrawer);
        if (cartOverlay) cartOverlay.addEventListener('click', closeCartDrawer);

        // Close on escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' && isCartOpen) {
                closeCartDrawer();
            }
        });

        // Get currency symbol
        function getCurrencySymbol(currency) {
            const symbols = {
                'EUR': '€', 'USD': '$', 'GBP': '£', 'CAD': 'C$', 'AUD': 'A$',
                'JPY': '¥', 'PLN': 'zł', 'RON': 'lei', 'HUF': 'Ft', 'CZK': 'Kč',
                'SEK': 'kr', 'DKK': 'kr', 'NOK': 'kr', 'BGN': 'лв', 'CHF': 'Fr',
                'TRY': '₺', 'BRL': 'R$', 'MXN': '$', 'INR': '₹', 'CNY': '¥'
            };
            return symbols[currency] || currency + ' ';
        }

        // Format price - Shopify returns prices in minor units (cents)
        // Auto-detect if value needs division (handles both cents and decimal formats)
        function formatPrice(amount, currency) {
            const symbol = getCurrencySymbol(currency);

            console.log('formatPrice input:', { amount, currency });

            // TRUE zero-decimal currencies only
            const zeroDecimalCurrencies = ['JPY', 'KRW', 'CLP', 'PYG', 'VND', 'ISK'];

            // Auto-detect: if amount > 10000 and not zero-decimal, likely already in decimal format
            let needsDivision = true;
            if (!zeroDecimalCurrencies.includes(currency)) {
                // If amount is very large (>10000) and ends with 00, might be pre-divided
                if (amount > 10000 && amount % 1 === 0) {
                    // Check if dividing would give an absurdly small number
                    const divided = amount / 100;
                    if (divided < 1) {
                        needsDivision = false;
                        console.log('Auto-detected: amount is likely already in decimal format');
                    }
                }
            }

            let actualAmount;
            if (zeroDecimalCurrencies.includes(currency)) {
                // Zero-decimal currencies: no division needed
                actualAmount = Number(amount);
                console.log('Zero-decimal currency, no division');
            } else if (needsDivision) {
                // Standard currencies: divide by 100
                actualAmount = amount / 100;
                console.log('Dividing by 100:', actualAmount);
            } else {
                // Already in decimal format
                actualAmount = Number(amount);
                console.log('Using amount as-is:', actualAmount);
            }

            const result = symbol + actualAmount.toFixed(2);
            console.log('formatPrice output:', result);
            return result;
        }

        // Fetch and render cart
        async function fetchCart() {
            console.log('=== CART: Fetching ===');

            if (!isInitialized) {
                if (cartLoadingState) cartLoadingState.classList.remove('hidden');
                if (cartEmptyState) cartEmptyState.classList.add('hidden');
                if (cartItemsList) cartItemsList.classList.add('hidden');
                if (cartFooter) cartFooter.classList.add('hidden');
            }

            try {
                const response = await fetch('{{ routes.cart_url }}.js');
                if (!response.ok) throw new Error('Failed to fetch cart');

                const cart = await response.json();

                console.log('=== CART DATA ===');
                console.log('Items:', cart.item_count);
                console.log('Currency:', cart.currency);
                console.log('Total price (raw):', cart.total_price);
                console.log('Cart items:', cart.items.map(i => ({
                    title: i.product_title,
                    price: i.price,
                    quantity: i.quantity,
                    total: i.price * i.quantity
                })));

                isInitialized = true;
                if (cartLoadingState) cartLoadingState.classList.add('hidden');
                renderCart(cart);
            } catch (error) {
                console.error('Cart fetch error:', error);
                if (cartLoadingState) cartLoadingState.classList.add('hidden');
            }
        }

        // Render cart
        function renderCart(cart) {
            const itemCount = cart.item_count;
            const subtotal = cart.total_price;
            const items = cart.items;
            const currency = cart.currency;

            // Update badge
            if (cartCount) {
                if (itemCount > 0) {
                    cartCount.textContent = itemCount;
                    cartCount.classList.remove('hidden');
                } else {
                    cartCount.classList.add('hidden');
                }
            }
            if (cartCountHeader) {
                cartCountHeader.textContent = itemCount > 0 ? itemCount : '0';
            }

            // Toggle states
            if (itemCount > 0) {
                if (cartEmptyState) cartEmptyState.classList.add('hidden');
                if (cartItemsList) cartItemsList.classList.remove('hidden');
                if (cartFooter) cartFooter.classList.remove('hidden');
            } else {
                if (cartEmptyState) cartEmptyState.classList.remove('hidden');
                if (cartItemsList) cartItemsList.classList.add('hidden');
                if (cartFooter) cartFooter.classList.add('hidden');
            }

            // Update subtotal
            if (cartSubtotal) {
                cartSubtotal.textContent = formatPrice(subtotal, currency);
            }

            // Render items
            if (cartItemsList) {
                cartItemsList.innerHTML = items.map((item, index) => {
                    const price = formatPrice(item.final_line_price, currency);
                    const originalPrice = item.original_line_price !== item.final_line_price
                        ? formatPrice(item.original_line_price, currency)
                        : null;

                    return `
                      <div class="flex gap-4 p-4 cart-item" data-key="${item.key}">
                        <div class="flex-shrink-0">
                          ${item.image
                            ? `<a href="${item.url}" class="block w-20 h-20 rounded-lg overflow-hidden bg-gray-100">
                                <img src="${item.image.replace(/(\.\w+)(\?.*)?$/, '_compact$1')}" alt="${item.product_title}" class="w-full h-full object-cover">
                              </a>`
                            : `<div class="w-20 h-20 rounded-lg bg-gray-100 flex items-center justify-center">
                                <svg class="w-8 h-8 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/>
                                </svg>
                              </div>`
                          }
                        </div>
                        <div class="flex-1 min-w-0">
                          <div class="flex items-start justify-between gap-2">
                            <div class="min-w-0">
                              <h3 class="text-sm font-semibold text-gray-900 truncate">
                                <a href="${item.url}" class="hover:text-purple-600">${item.product_title}</a>
                              </h3>
                              ${item.variant_title && item.variant_title !== 'Default Title'
                                ? `<p class="text-xs text-gray-500 truncate">${item.variant_title}</p>`
                                : ''
                              }
                            </div>
                            <button class="cart-item-remove text-gray-400 hover:text-red-500 p-1" data-key="${item.key}">
                              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                              </svg>
                            </button>
                          </div>
                          <div class="flex items-center justify-between mt-3">
                            <div class="flex items-center border border-gray-200 rounded-lg">
                              <button class="cart-quantity-minus px-2 py-1" data-key="${item.key}" ${item.quantity <= 1 ? 'disabled' : ''}>
                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4"/>
                                </svg>
                              </button>
                              <input type="number" name="updates[]" value="${item.quantity}" min="0"
                                     class="cart-quantity-input w-12 text-center border-0 text-sm" data-key="${item.key}">
                              <button class="cart-quantity-plus px-2 py-1" data-key="${item.key}">
                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                                </svg>
                              </button>
                            </div>
                            <div class="text-sm font-bold text-gray-900">
                              ${originalPrice
                                ? `<span class="line-through text-gray-400 mr-2">${originalPrice}</span>${price}`
                                : price
                              }
                            </div>
                          </div>
                        </div>
                      </div>
                    `;
                }).join('');
            }

            // Attach listeners
            attachListeners();
        }

        // Attach event listeners
        function attachListeners() {
            if (!cartItemsList) return;

            // Remove item buttons
            cartItemsList.querySelectorAll('.cart-item-remove').forEach(btn => {
                btn.addEventListener('click', async () => {
                    const key = btn.dataset.key;
                    if (confirm('Remove this item?')) {
                        await updateQty(key, 0);
                    }
                });
            });

            // Quantity minus buttons
            cartItemsList.querySelectorAll('.cart-quantity-minus').forEach(btn => {
                btn.addEventListener('click', async () => {
                    const key = btn.dataset.key;
                    if (btn.disabled) return;
                    const input = cartItemsList.querySelector(`.cart-quantity-input[data-key="${key}"]`);
                    const qty = parseInt(input.value);
                    if (qty > 1) {
                        await updateQty(key, qty - 1);
                    } else if (confirm('Remove this item?')) {
                        await updateQty(key, 0);
                    }
                });
            });

            // Quantity plus buttons
            cartItemsList.querySelectorAll('.cart-quantity-plus').forEach(btn => {
                btn.addEventListener('click', async () => {
                    const key = btn.dataset.key;
                    const input = cartItemsList.querySelector(`.cart-quantity-input[data-key="${key}"]`);
                    await updateQty(key, parseInt(input.value) + 1);
                });
            });

            // Quantity input changes
            cartItemsList.querySelectorAll('.cart-quantity-input').forEach(input => {
                input.addEventListener('change', async () => {
                    const key = input.dataset.key;
                    let val = parseInt(input.value);
                    if (isNaN(val) || val < 0) val = 1;
                    if (val === 0) {
                        if (confirm('Remove this item?')) {
                            await updateQty(key, 0);
                        } else {
                            input.value = 1;
                        }
                    } else {
                        await updateQty(key, val);
                    }
                });
            });
        }

        // Update quantity using key (more reliable than line number)
        async function updateQty(key, quantity) {
            try {
                console.log('Updating quantity:', key, 'to', quantity);
                const res = await fetch('{{ routes.cart_change_url }}.js', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id: key, quantity: quantity })
                });
                if (res.ok) {
                    const cart = await res.json();
                    renderCart(cart);
                    if (cart.item_count === 0) {
                        setTimeout(closeCartDrawer, 500);
                    }
                } else {
                    console.error('Update failed:', res.status);
                }
            } catch (e) {
                console.error('Update error:', e);
            }
        }

        // Initial fetch
        fetchCart();

        // Expose refresh function globally
        window.refreshCartDrawer = fetchCart;
    }

    // Initialize when DOM is ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initCartDrawer);
    } else {
        initCartDrawer();
    }
})();
</script>
