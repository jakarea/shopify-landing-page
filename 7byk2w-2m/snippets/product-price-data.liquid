<script>
// Country flag emojis (ISO 3166-1 alpha-2 code to flag)
const countryCodeToFlag = {
    'US': 'üá∫üá∏', 'CA': 'üá®üá¶', 'AU': 'üá¶üá∫', 'JP': 'üáØüáµ',
    'GB': 'üá¨üáß', 'PL': 'üáµüá±', 'RO': 'üá∑üá¥', 'HU': 'üá≠üá∫',
    'CZ': 'üá®üáø', 'SE': 'üá∏üá™', 'DK': 'üá©üá∞', 'NO': 'üá≥üá¥',
    'BG': 'üáßüá¨', 'CH': 'üá®üá≠', 'TR': 'üáπüá∑', 'BD': 'üáßüá©',
    'IT': 'üáÆüáπ', 'FR': 'üá´üá∑', 'DE': 'üá©üá™', 'ES': 'üá™üá∏',
    'PT': 'üáµüáπ', 'NL': 'üá≥üá±', 'IE': 'üáÆüá™', 'AT': 'üá¶üáπ',
    'BE': 'üáßüá™', 'FI': 'üá´üáÆ', 'GR': 'üá¨üá∑', 'SK': 'üá∏üá∞',
    'SI': 'üá∏üáÆ', 'LT': 'üá±üáπ', 'LV': 'üá±üáª', 'EE': 'üá™üá™',
    'LU': 'üá±üá∫', 'CY': 'üá®üáæ', 'MT': 'üá≤üáπ', 'IN': 'üáÆüá≥',
    'BR': 'üáßüá∑', 'AR': 'üá¶üá∑', 'MX': 'üá≤üáΩ', 'ZA': 'üáøüá¶',
    'NZ': 'üá≥üáø', 'SG': 'üá∏üá¨', 'MY': 'üá≤üáæ', 'TH': 'üáπüá≠',
    'VN': 'üáªüá≥', 'ID': 'üáÆüá©', 'PH': 'üáµüá≠', 'KR': 'üá∞üá∑',
    'CN': 'üá®üá≥', 'TW': 'üáπüáº', 'HK': 'üá≠üá∞', 'IL': 'üáÆüá±',
    'AE': 'üá¶üá™', 'SA': 'üá∏üá¶', 'QA': 'üá∂üá¶', 'KW': 'üá∞üáº',
    'RU': 'üá∑üá∫', 'UA': 'üá∫üá¶', 'BY': 'üáßüáæ', 'KZ': 'üá∞üáø',
    'IS': 'üáÆüá∏', 'LI': 'üá±üáÆ', 'MK': 'üá≤üá∞', 'AL': 'üá¶üá±',
    'RS': 'üá∑üá∏', 'BA': 'üáßüá¶', 'ME': 'üá≤üá™', 'HR': 'üá≠üá∑',
    'CO': 'üá®üá¥', 'PE': 'üáµüá™', 'CL': 'üá®üá±', 'EC': 'üá™üá®',
    'VE': 'üáªüá™', 'UY': 'üá∫üáæ', 'PY': 'üáµüáæ', 'BO': 'üáßüá¥',
    'CR': 'üá®üá∑', 'PA': 'üáµüá¶', 'GT': 'üá¨üáπ', 'SV': 'üá∏üáª',
    'HN': 'üá≠üá≥', 'NI': 'üá≥üáÆ', 'DO': 'üá©üá¥', 'JM': 'üáØüá≤',
    'TT': 'üáπüáπ', 'BB': 'üáßüáß', 'BS': 'üáßüá∏', 'GD': 'üá¨üá©',
    'KE': 'üá∞üá™', 'NG': 'üá≥üá¨', 'GH': 'üá¨üá≠', 'EG': 'üá™üá¨',
    'MA': 'üá≤üá¶', 'DZ': 'üá©üáø', 'TN': 'üáπüá≥', 'LY': 'üá±üáæ'
};

// Map countries to currencies
const countryToCurrency = {
    'US': 'USD', 'CA': 'CAD', 'AU': 'AUD', 'JP': 'JPY',
    'GB': 'GBP', 'PL': 'PLN', 'RO': 'RON', 'HU': 'HUF',
    'CZ': 'CZK', 'SE': 'SEK', 'DK': 'DKK', 'NO': 'NOK',
    'BG': 'BGN', 'CH': 'CHF', 'TR': 'TRY', 'BD': 'BDT',
    'IT': 'EUR', 'FR': 'EUR', 'DE': 'EUR', 'ES': 'EUR',
    'PT': 'EUR', 'NL': 'EUR', 'IE': 'EUR', 'AT': 'EUR',
    'BE': 'EUR', 'FI': 'EUR', 'GR': 'EUR', 'SK': 'EUR',
    'SI': 'EUR', 'LT': 'EUR', 'LV': 'EUR', 'EE': 'EUR',
    'LU': 'EUR', 'CY': 'EUR', 'MT': 'EUR',
    // Asian countries
    'MY': 'MYR', 'TH': 'THB', 'VN': 'VND', 'ID': 'IDR',
    'PH': 'PHP', 'SG': 'SGD', 'IN': 'INR', 'PK': 'PKR',
    'LK': 'LKR', 'NP': 'NPR', 'BD': 'BDT', 'CN': 'CNY',
    'TW': 'TWD', 'HK': 'HKD', 'KR': 'KRW', 'BN': 'BND',
    'KH': 'KHR', 'LA': 'LAK', 'MM': 'MMK', 'NZ': 'NZD',
    // Middle East
    'IL': 'ILS', 'AE': 'AED', 'SA': 'SAR', 'QA': 'QAR',
    'KW': 'KWD', 'OM': 'OMR', 'BH': 'BHD', 'JO': 'JOD',
    'LB': 'LBP', 'EG': 'EGP', 'MA': 'MAD', 'DZ': 'DZ',
    'TN': 'TND', 'LY': 'LYD', 'NG': 'NGN', 'KE': 'KES',
    'GH': 'GHS', 'ZA': 'ZAR', 'NA': 'NAD', 'BW': 'BWP',
    // Americas
    'BR': 'BRL', 'AR': 'ARS', 'MX': 'MXN', 'CO': 'COP',
    'PE': 'PEN', 'CL': 'CLP', 'EC': 'USD', 'VE': 'USD',
    'UY': 'UYU', 'PY': 'PYG', 'BO': 'BOB', 'CR': 'CRC',
    'PA': 'USD', 'GT': 'GTQ', 'SV': 'USD', 'HN': 'HNL',
    'NI': 'NIO', 'DO': 'DOP', 'JM': 'JMD', 'TT': 'TTD',
    'BB': 'BBD', 'BS': 'BSD', 'GD': 'XCD',
    // Russia and neighbors
    'RU': 'RUB', 'UA': 'UAH', 'BY': 'BYN', 'KZ': 'KZT',
    'IS': 'ISK', 'LI': 'CHF', 'MK': 'MKD', 'AL': 'ALL',
    'RS': 'RSD', 'BA': 'BAM', 'ME': 'EUR', 'HR': 'EUR'
};

// Country names mapping
const countryNames = {
    'US': 'United States', 'CA': 'Canada', 'AU': 'Australia', 'JP': 'Japan',
    'GB': 'United Kingdom', 'PL': 'Poland', 'RO': 'Romania', 'HU': 'Hungary',
    'CZ': 'Czech Republic', 'SE': 'Sweden', 'DK': 'Denmark', 'NO': 'Norway',
    'BG': 'Bulgaria', 'CH': 'Switzerland', 'TR': 'Turkey', 'BD': 'Bangladesh',
    'IT': 'Italy', 'FR': 'France', 'DE': 'Germany', 'ES': 'Spain',
    'PT': 'Portugal', 'NL': 'Netherlands', 'IE': 'Ireland', 'AT': 'Austria',
    'BE': 'Belgium', 'FI': 'Finland', 'GR': 'Greece', 'SK': 'Slovakia',
    'SI': 'Slovenia', 'LT': 'Lithuania', 'LV': 'Latvia', 'EE': 'Estonia',
    'LU': 'Luxembourg', 'CY': 'Cyprus', 'MT': 'Malta', 'IN': 'India',
    'BR': 'Brazil', 'AR': 'Argentina', 'MX': 'Mexico', 'ZA': 'South Africa',
    'NZ': 'New Zealand', 'SG': 'Singapore', 'MY': 'Malaysia', 'TH': 'Thailand',
    'VN': 'Vietnam', 'ID': 'Indonesia', 'PH': 'Philippines', 'KR': 'South Korea',
    'CN': 'China', 'TW': 'Taiwan', 'HK': 'Hong Kong', 'IL': 'Israel',
    'AE': 'United Arab Emirates', 'SA': 'Saudi Arabia', 'QA': 'Qatar', 'KW': 'Kuwait'
};

// Default prices in EUR
const DEFAULT_PRICES_EUR = {
    'basic-bundle': { price: 29, original: 54 },
    'premium-bundle': { price: 59, original: 140 }
};

// Exchange rates relative to EUR
const RATES_TO_EUR = {
    'EUR': 1, 'USD': 1.08, 'GBP': 0.86, 'CAD': 1.47,
    'AUD': 1.62, 'JPY': 162, 'PLN': 4.32, 'RON': 4.97,
    'HUF': 385, 'CZK': 25.3, 'SEK': 11.2, 'DKK': 7.45,
    'NOK': 11.4, 'BGN': 1.96, 'CHF': 0.94, 'TRY': 35.2,
    'BDT': 117,
    // Asian currencies
    'MYR': 4.55, 'THB': 37, 'VND': 27000, 'IDR': 16500,
    'PHP': 62, 'SGD': 1.45, 'INR': 90, 'PKR': 300,
    'LKR': 330, 'NPR': 145, 'CNY': 7.8, 'TWD': 34,
    'HKD': 8.4, 'KRW': 1450, 'BND': 1.45, 'KHR': 4400,
    'LAK': 24000, 'MMK': 23000, 'NZD': 1.75,
    // Middle East currencies
    'ILS': 4.0, 'AED': 4.0, 'SAR': 4.1, 'QAR': 4.0,
    'KWD': 0.34, 'OMR': 0.42, 'BHD': 0.41, 'JOD': 0.77,
    'LBP': 95000, 'EGP': 53, 'MAD': 11, 'DZD': 145,
    'TND': 34, 'LYD': 5.4, 'NGN': 1600, 'KES': 150,
    'GHS': 17, 'ZAR': 20, 'NAD': 20, 'BWP': 14.5,
    // Americas currencies
    'BRL': 5.4, 'ARS': 1100, 'MXN': 18, 'COP': 4500,
    'PEN': 4.0, 'CLP': 950, 'UYU': 42, 'PYG': 8000,
    'BOB': 7.5, 'CRC': 5600, 'GTQ': 8.5, 'HNL': 27,
    'NIO': 38, 'DOP': 63, 'JMD': 170, 'TTD': 7.3,
    'BBD': 2.2, 'BSD': 1.5, 'XCD': 4.0,
    // Russia and neighbors
    'RUB': 100, 'UAH': 42, 'BYN': 2.8, 'KZT': 470,
    'ISK': 150, 'MKD': 62, 'ALL': 105, 'BAM': 2.0
};

// Currency symbols
const CURRENCY_SYMBOLS = {
    'EUR': '‚Ç¨', 'USD': '$', 'GBP': '¬£', 'CAD': 'C$',
    'AUD': 'A$', 'JPY': '¬•', 'PLN': 'z≈Ç', 'RON': 'lei',
    'HUF': 'Ft', 'CZK': 'Kƒç', 'SEK': 'kr', 'DKK': 'kr',
    'NOK': 'kr', 'BGN': '–ª–≤', 'CHF': 'Fr', 'TRY': '‚Ç∫',
    'BDT': '‡ß≥',
    // Asian currencies
    'MYR': 'RM', 'THB': '‡∏ø', 'VND': '‚Ç´', 'IDR': 'Rp',
    'PHP': '‚Ç±', 'SGD': 'S$', 'INR': '‚Çπ', 'PKR': 'Rs',
    'LKR': 'Rs', 'NPR': 'Rs', 'CNY': '¬•', 'TWD': 'NT$',
    'HKD': 'HK$', 'KRW': '‚Ç©', 'BND': 'B$', 'KHR': '·üõ',
    'LAK': '‚Ç≠', 'MMK': 'Ks', 'NZD': 'NZ$',
    // Middle East currencies
    'ILS': '‚Ç™', 'AED': 'ÿØ.ÿ•', 'SAR': 'Ô∑º', 'QAR': 'Ô∑º',
    'KWD': 'ÿØ.ŸÉ', 'OMR': 'ÿ±.ÿπ.', 'BHD': 'BD', 'JOD': 'ÿØ.ÿß',
    'LBP': 'ŸÑ.ŸÑ', 'EGP': 'E¬£', 'MAD': 'ÿØ.ŸÖ.', 'DZD': 'ÿØ.ÿ¨',
    'TND': 'ÿØ.ÿ™', 'LYD': 'ŸÑ.ÿØ', 'NGN': '‚Ç¶', 'KES': 'KSh',
    'GHS': '‚Çµ', 'ZAR': 'R', 'NAD': 'N$', 'BWP': 'P',
    // Americas currencies
    'BRL': 'R$', 'ARS': '$', 'MXN': '$', 'COP': '$',
    'PEN': 'S/', 'CLP': '$', 'UYU': '$', 'PYG': '‚Ç≤',
    'BOB': 'Bs', 'CRC': '‚Ç°', 'GTQ': 'Q', 'HNL': 'L',
    'NIO': 'C$', 'DOP': 'RD$', 'JMD': 'J$', 'TTD': 'TT$',
    'BBD': 'Bds$', 'BSD': 'B$', 'XCD': 'EC$',
    // Russia and neighbors
    'RUB': '‚ÇΩ', 'UAH': '‚Ç¥', 'BYN': 'Br', 'KZT': '‚Ç∏',
    'ISK': 'kr', 'MKD': '–¥–µ–Ω', 'ALL': 'L', 'BAM': 'KM'
};

// Convert price from EUR to target currency
function convertPriceFromEur(eurPrice, targetCurrency) {
    if (targetCurrency === 'EUR') return eurPrice;
    const rate = RATES_TO_EUR[targetCurrency] || 1;
    return Math.round(eurPrice * rate);
}

// Format price with currency symbol
function formatPrice(amount, currency) {
    const symbol = CURRENCY_SYMBOLS[currency] || currency + ' ';
    return symbol + Math.round(amount);
}

// Update all prices on the page
function updatePricesWithCurrency(currency) {
    document.querySelectorAll('[data-pricing-section]').forEach(container => {
        ['basic-bundle', 'premium-bundle'].forEach(bundleKey => {
            const priceEl = container.querySelector(`[data-product-pricing="${bundleKey}"] .data-price`);
            const originalEl = container.querySelector(`[data-product-pricing="${bundleKey}"] .data-original-price`);
            const discountEl = container.querySelector(`[data-product-pricing="${bundleKey}"] .data-discount-badge`);

            if (!priceEl) return;

            const defaults = DEFAULT_PRICES_EUR[bundleKey];
            const convertedPrice = convertPriceFromEur(defaults.price, currency);
            const formattedPrice = formatPrice(convertedPrice, currency) + ' ';
            priceEl.textContent = formattedPrice;

            if (originalEl) originalEl.style.display = 'none';
            if (discountEl) discountEl.style.display = 'none';
        });
    });

    // Update guarantee price
    const guaranteePriceEl = document.getElementById('guarantee-price');
    if (guaranteePriceEl) {
        const convertedPrice = convertPriceFromEur(DEFAULT_PRICES_EUR['premium-bundle'].price, currency);
        guaranteePriceEl.textContent = formatPrice(convertedPrice, currency);
    }
}

// Store the function globally so it can be called after API detection
window.updatePricesWithCurrency = updatePricesWithCurrency;

// Initialize currency system
window.SHOPIFY_CURRENCY_SYMBOL = "{{ cart.currency.symbol }}";
window.SHOPIFY_SHOP_URL = "{{ request.host }}";
window.SHOPIFY_BASE_CURRENCY = "{{ shop.currency }}";

// Store exchange rates from Shopify Markets (relative to base currency)
window.SHOPIFY_EXCHANGE_RATES = {
    {% for currency in shop.enabled_currencies %}
    '{{ currency.iso_code }}': {
        rate: {{ currency.rate | default: 1 }},
        symbol: "{{ currency.symbol }}"
    }{% unless forloop.last %},{% endunless %}
    {% endfor %}
};

// Detect country and initialize prices
(async function detectCountryAndInit() {
    let countryCode = "{{ request.country_code }}" || null;

    // If Shopify detected country, use it
    if (countryCode && countryCode !== '' && countryCode !== 'null') {
        initCurrency(countryCode);
        return;
    }

    // Otherwise fetch from IP geolocation API
    try {
        const response = await fetch('https://ipapi.co/json/');
        const data = await response.json();
        countryCode = data.country_code;
        initCurrency(countryCode);
    } catch (error) {
        // Fallback to browser locale
        const locale = navigator.language || navigator.userLanguage || 'en-US';
        countryCode = locale.split('-')[1] || locale.toUpperCase();
        initCurrency(countryCode);
    }
})();

function initCurrency(countryCode) {
    const detectedCurrency = countryToCurrency[countryCode] || 'EUR';
    const detectedFlag = countryCodeToFlag[countryCode] || 'üåç';
    const countryName = countryNames[countryCode] || countryCode;
    const currencySymbol = CURRENCY_SYMBOLS[detectedCurrency] || detectedCurrency + ' ';

    // Update global variables
    window.SHOPIFY_CURRENCY = detectedCurrency;
    window.VISITOR_COUNTRY = countryCode;
    window.VISITOR_FLAG = detectedFlag;

    // Calculate converted prices
    const basicPriceEur = DEFAULT_PRICES_EUR['basic-bundle'].price;
    const premiumPriceEur = DEFAULT_PRICES_EUR['premium-bundle'].price;
    const basicPriceConverted = convertPriceFromEur(basicPriceEur, detectedCurrency);
    const premiumPriceConverted = convertPriceFromEur(premiumPriceEur, detectedCurrency);
    const basicPriceFormatted = formatPrice(basicPriceConverted, detectedCurrency);
    const premiumPriceFormatted = formatPrice(premiumPriceConverted, detectedCurrency);

    // Update flag in hero
    const detectedFlagEl = document.querySelector('.detected-flag');
    if (detectedFlagEl) {
        detectedFlagEl.textContent = detectedFlag;
    }

    // Update prices with detected currency
    updatePricesWithCurrency(detectedCurrency);
}
</script>
