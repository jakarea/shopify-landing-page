<script>
// Country flag emojis (ISO 3166-1 alpha-2 code to flag)
const countryCodeToFlag = {
    'US': 'ðŸ‡ºðŸ‡¸', 'CA': 'ðŸ‡¨ðŸ‡¦', 'AU': 'ðŸ‡¦ðŸ‡º', 'JP': 'ðŸ‡¯ðŸ‡µ',
    'GB': 'ðŸ‡¬ðŸ‡§', 'PL': 'ðŸ‡µðŸ‡±', 'RO': 'ðŸ‡·ðŸ‡´', 'HU': 'ðŸ‡­ðŸ‡º',
    'CZ': 'ðŸ‡¨ðŸ‡¿', 'SE': 'ðŸ‡¸ðŸ‡ª', 'DK': 'ðŸ‡©ðŸ‡°', 'NO': 'ðŸ‡³ðŸ‡´',
    'BG': 'ðŸ‡§ðŸ‡¬', 'CH': 'ðŸ‡¨ðŸ‡­', 'TR': 'ðŸ‡¹ðŸ‡·', 'BD': 'ðŸ‡§ðŸ‡©',
    'IT': 'ðŸ‡®ðŸ‡¹', 'FR': 'ðŸ‡«ðŸ‡·', 'DE': 'ðŸ‡©ðŸ‡ª', 'ES': 'ðŸ‡ªðŸ‡¸',
    'PT': 'ðŸ‡µðŸ‡¹', 'NL': 'ðŸ‡³ðŸ‡±', 'IE': 'ðŸ‡®ðŸ‡ª', 'AT': 'ðŸ‡¦ðŸ‡¹',
    'BE': 'ðŸ‡§ðŸ‡ª', 'FI': 'ðŸ‡«ðŸ‡®', 'GR': 'ðŸ‡¬ðŸ‡·', 'SK': 'ðŸ‡¸ðŸ‡°',
    'SI': 'ðŸ‡¸ðŸ‡®', 'LT': 'ðŸ‡±ðŸ‡¹', 'LV': 'ðŸ‡±ðŸ‡»', 'EE': 'ðŸ‡ªðŸ‡ª',
    'LU': 'ðŸ‡±ðŸ‡º', 'CY': 'ðŸ‡¨ðŸ‡¾', 'MT': 'ðŸ‡²ðŸ‡¹', 'IN': 'ðŸ‡®ðŸ‡³',
    'BR': 'ðŸ‡§ðŸ‡·', 'AR': 'ðŸ‡¦ðŸ‡·', 'MX': 'ðŸ‡²ðŸ‡½', 'ZA': 'ðŸ‡¿ðŸ‡¦',
    'NZ': 'ðŸ‡³ðŸ‡¿', 'SG': 'ðŸ‡¸ðŸ‡¬', 'MY': 'ðŸ‡²ðŸ‡¾', 'TH': 'ðŸ‡¹ðŸ‡­',
    'VN': 'ðŸ‡»ðŸ‡³', 'ID': 'ðŸ‡®ðŸ‡©', 'PH': 'ðŸ‡µðŸ‡­', 'KR': 'ðŸ‡°ðŸ‡·',
    'CN': 'ðŸ‡¨ðŸ‡³', 'TW': 'ðŸ‡¹ðŸ‡¼', 'HK': 'ðŸ‡­ðŸ‡°', 'IL': 'ðŸ‡®ðŸ‡±',
    'AE': 'ðŸ‡¦ðŸ‡ª', 'SA': 'ðŸ‡¸ðŸ‡¦', 'QA': 'ðŸ‡¶ðŸ‡¦', 'KW': 'ðŸ‡°ðŸ‡¼',
    'RU': 'ðŸ‡·ðŸ‡º', 'UA': 'ðŸ‡ºðŸ‡¦', 'BY': 'ðŸ‡§ðŸ‡¾', 'KZ': 'ðŸ‡°ðŸ‡¿',
    'IS': 'ðŸ‡®ðŸ‡¸', 'LI': 'ðŸ‡±ðŸ‡®', 'MK': 'ðŸ‡²ðŸ‡°', 'AL': 'ðŸ‡¦ðŸ‡±',
    'RS': 'ðŸ‡·ðŸ‡¸', 'BA': 'ðŸ‡§ðŸ‡¦', 'ME': 'ðŸ‡²ðŸ‡ª', 'HR': 'ðŸ‡­ðŸ‡·',
    'CO': 'ðŸ‡¨ðŸ‡´', 'PE': 'ðŸ‡µðŸ‡ª', 'CL': 'ðŸ‡¨ðŸ‡±', 'EC': 'ðŸ‡ªðŸ‡¨',
    'VE': 'ðŸ‡»ðŸ‡ª', 'UY': 'ðŸ‡ºðŸ‡¾', 'PY': 'ðŸ‡µðŸ‡¾', 'BO': 'ðŸ‡§ðŸ‡´',
    'CR': 'ðŸ‡¨ðŸ‡·', 'PA': 'ðŸ‡µðŸ‡¦', 'GT': 'ðŸ‡¬ðŸ‡¹', 'SV': 'ðŸ‡¸ðŸ‡»',
    'HN': 'ðŸ‡­ðŸ‡³', 'NI': 'ðŸ‡³ðŸ‡®', 'DO': 'ðŸ‡©ðŸ‡´', 'JM': 'ðŸ‡¯ðŸ‡²',
    'TT': 'ðŸ‡¹ðŸ‡¹', 'BB': 'ðŸ‡§ðŸ‡§', 'BS': 'ðŸ‡§ðŸ‡¸', 'GD': 'ðŸ‡¬ðŸ‡©',
    'KE': 'ðŸ‡°ðŸ‡ª', 'NG': 'ðŸ‡³ðŸ‡¬', 'GH': 'ðŸ‡¬ðŸ‡­', 'EG': 'ðŸ‡ªðŸ‡¬',
    'MA': 'ðŸ‡²ðŸ‡¦', 'DZ': 'ðŸ‡©ðŸ‡¿', 'TN': 'ðŸ‡¹ðŸ‡³', 'LY': 'ðŸ‡±ðŸ‡¾'
};

// Map countries to currencies
const countryToCurrency = {
    'US': 'USD', 'CA': 'CAD', 'AU': 'AUD', 'JP': 'JPY',
    'GB': 'GBP', 'PL': 'PLN', 'RO': 'RON', 'HU': 'HUF',
    'CZ': 'CZK', 'SE': 'SEK', 'DK': 'DKK', 'NO': 'NOK',
    'BG': 'BGN', 'CH': 'CHF', 'TR': 'TRY', 'BD': 'BDT',
    'IT': 'EUR', 'FR': 'EUR', 'DE': 'EUR', 'ES': 'EUR',
    'PT': 'EUR', 'NL': 'EUR', 'IE': 'EUR', 'AT': 'EUR',
    'BE': 'EUR', 'FI': 'EUR', 'GR': 'EUR', 'SK': 'EUR',
    'SI': 'EUR', 'LT': 'EUR', 'LV': 'EUR', 'EE': 'EUR',
    'LU': 'EUR', 'CY': 'EUR', 'MT': 'EUR',
    // Asian countries
    'MY': 'MYR', 'TH': 'THB', 'VN': 'VND', 'ID': 'IDR',
    'PH': 'PHP', 'SG': 'SGD', 'IN': 'INR', 'PK': 'PKR',
    'LK': 'LKR', 'NP': 'NPR', 'BD': 'BDT', 'CN': 'CNY',
    'TW': 'TWD', 'HK': 'HKD', 'KR': 'KRW', 'BN': 'BND',
    'KH': 'KHR', 'LA': 'LAK', 'MM': 'MMK', 'NZ': 'NZD',
    // Middle East
    'IL': 'ILS', 'AE': 'AED', 'SA': 'SAR', 'QA': 'QAR',
    'KW': 'KWD', 'OM': 'OMR', 'BH': 'BHD', 'JO': 'JOD',
    'LB': 'LBP', 'EG': 'EGP', 'MA': 'MAD', 'DZ': 'DZ',
    'TN': 'TND', 'LY': 'LYD', 'NG': 'NGN', 'KE': 'KES',
    'GH': 'GHS', 'ZA': 'ZAR', 'NA': 'NAD', 'BW': 'BWP',
    // Americas
    'BR': 'BRL', 'AR': 'ARS', 'MX': 'MXN', 'CO': 'COP',
    'PE': 'PEN', 'CL': 'CLP', 'EC': 'USD', 'VE': 'USD',
    'UY': 'UYU', 'PY': 'PYG', 'BO': 'BOB', 'CR': 'CRC',
    'PA': 'USD', 'GT': 'GTQ', 'SV': 'USD', 'HN': 'HNL',
    'NI': 'NIO', 'DO': 'DOP', 'JM': 'JMD', 'TT': 'TTD',
    'BB': 'BBD', 'BS': 'BSD', 'GD': 'XCD',
    // Russia and neighbors
    'RU': 'RUB', 'UA': 'UAH', 'BY': 'BYN', 'KZ': 'KZT',
    'IS': 'ISK', 'LI': 'CHF', 'MK': 'MKD', 'AL': 'ALL',
    'RS': 'RSD', 'BA': 'BAM', 'ME': 'EUR', 'HR': 'EUR'
};

// Country names mapping
const countryNames = {
    'US': 'United States', 'CA': 'Canada', 'AU': 'Australia', 'JP': 'Japan',
    'GB': 'United Kingdom', 'PL': 'Poland', 'RO': 'Romania', 'HU': 'Hungary',
    'CZ': 'Czech Republic', 'SE': 'Sweden', 'DK': 'Denmark', 'NO': 'Norway',
    'BG': 'Bulgaria', 'CH': 'Switzerland', 'TR': 'Turkey', 'BD': 'Bangladesh',
    'IT': 'Italy', 'FR': 'France', 'DE': 'Germany', 'ES': 'Spain',
    'PT': 'Portugal', 'NL': 'Netherlands', 'IE': 'Ireland', 'AT': 'Austria',
    'BE': 'Belgium', 'FI': 'Finland', 'GR': 'Greece', 'SK': 'Slovakia',
    'SI': 'Slovenia', 'LT': 'Lithuania', 'LV': 'Latvia', 'EE': 'Estonia',
    'LU': 'Luxembourg', 'CY': 'Cyprus', 'MT': 'Malta', 'IN': 'India',
    'BR': 'Brazil', 'AR': 'Argentina', 'MX': 'Mexico', 'ZA': 'South Africa',
    'NZ': 'New Zealand', 'SG': 'Singapore', 'MY': 'Malaysia', 'TH': 'Thailand',
    'VN': 'Vietnam', 'ID': 'Indonesia', 'PH': 'Philippines', 'KR': 'South Korea',
    'CN': 'China', 'TW': 'Taiwan', 'HK': 'Hong Kong', 'IL': 'Israel',
    'AE': 'United Arab Emirates', 'SA': 'Saudi Arabia', 'QA': 'Qatar', 'KW': 'Kuwait'
};

// Map country codes to available languages
// Falls back to 'en' if language not available
const countryToLanguage = {
    'IT': 'it', 'IT': 'it',
    'FR': 'fr',
    'DE': 'de',
    'ES': 'es',
    'PT': 'pt',
    'NL': 'nl',
    'PL': 'pl',
    'RO': 'ro',
    'HU': 'hu',
    'SK': 'sk',
    'CZ': 'cs',
    'SE': 'sv',
    'LT': 'lt',
    'GR': 'el',
    'HR': 'hr',
    'FI': 'fi',
    'DK': 'da',
    'GB': 'en',
    'US': 'en',
    'IE': 'en',
    'AT': 'de',
    'BE': 'nl',
    'CH': 'de',
    'LU': 'de',
    'BG': 'en',
    'EE': 'en',
    'LV': 'en',
    'SI': 'en',
    'CY': 'en',
    'MT': 'en'
};

// Available languages in the header
const availableLanguages = ['en', 'it', 'fr', 'de', 'es', 'pt', 'nl', 'pl', 'ro', 'hu', 'sk', 'cs', 'sv', 'lt', 'el', 'hr', 'fi', 'da'];

// Get language for country (fallback to 'en' if not available)
function getLanguageForCountry(countryCode) {
    const lang = countryToLanguage[countryCode];
    if (lang && availableLanguages.includes(lang)) {
        return lang;
    }
    return 'en'; // Default to English
}

// DEBUG: Log Shopify settings first
console.log('=== SHOPIFY SETTINGS DEBUG ===');
console.log('Shop Currency:', "{{ shop.currency }}");
console.log('Cart Currency:', "{{ cart.currency.iso_code }}");
console.log('Request Country Code:', "{{ request.country_code }}");

// Get products
{% assign basic_product = all_products['basic-bundle'] %}
{% assign premium_product = all_products['premium-bundle'] %}

// Check if products exist
{% if basic_product != blank %}
console.log('Basic product found: TRUE');
console.log('Basic product handle:', "{{ basic_product.handle }}");
console.log('Basic product ID:', "{{ basic_product.id }}");
{% else %}
console.log('Basic product found: FALSE');
{% endif %}

{% if premium_product != blank %}
console.log('Premium product found: TRUE');
console.log('Premium product handle:', "{{ premium_product.handle }}");
console.log('Premium product ID:', "{{ premium_product.id }}");
{% else %}
console.log('Premium product found: FALSE');
{% endif %}

// Store product IDs for fetching
window.SHOPIFY_PRODUCT_IDS = {
    {% if basic_product != blank %}
    'basic-bundle': {{ basic_product.id }},
    {% endif %}
    {% if premium_product != blank %}
    'premium-bundle': {{ premium_product.id }}
    {% endif %}
};

console.log('Product IDs for API fetch:', window.SHOPIFY_PRODUCT_IDS);

{% if premium_product != blank %}
console.log('Premium product found: TRUE');
console.log('Premium product handle:', "{{ premium_product.handle }}");
console.log('Premium product price (raw):', {{ premium_product.price }});
console.log('Premium product price (formatted):', "{{ premium_product.price | money }}");
{% else %}
console.log('Premium product found: FALSE');
{% endif %}

// Get prices from Shopify Admin dynamically via AJAX
// Prices are fetched from Shopify AJAX API and converted from visitor currency to EUR
// Then converted back to visitor's currency for display

{% comment %} Get product handles for variant IDs {% endcomment %}
{% assign basic_product = all_products['basic-bundle'] %}
{% assign premium_product = all_products['premium-bundle'] %}

{% comment %} Shop currency settings {% endcomment %}
const SHOP_CURRENCY = "{{ shop.currency }}";
const CART_CURRENCY = "{{ cart.currency.iso_code }}";

{% comment %} Initialize prices object - will be populated by AJAX fetch {% endcomment %}
const DEFAULT_PRICES_EUR = {
    'basic-bundle': {
        price: 0,
        original: 0
    },
    'premium-bundle': {
        price: 0,
        original: 0
    }
};

// Get Shopify variant IDs from products
{% if basic_product != blank and basic_product.variants.first.id != blank %}
window.SHOPIFY_VARIANT_BASIC = {{ basic_product.variants.first.id }};
{% else %}
window.SHOPIFY_VARIANT_BASIC = null;
{% endif %}
{% if premium_product != blank and premium_product.variants.first.id != blank %}
window.SHOPIFY_VARIANT_PREMIUM = {{ premium_product.variants.first.id }};
{% else %}
window.SHOPIFY_VARIANT_PREMIUM = null;
{% endif %}

{% comment %} Zero-decimal currencies that don't use decimal places {% endcomment %}
const ZERO_DECIMAL_CURRENCIES = ['HUF', 'JPY', 'KRW', 'CLP', 'PYG', 'VND', 'ISK', 'BIF', 'DJF', 'GNF', 'KMF', 'MGA', 'RWF', 'UGX'];

{% comment %} Debug: Currency settings {% endcomment %}
console.log('=== CURRENCY SETTINGS ===');
console.log('Shop currency:', SHOP_CURRENCY);
console.log('Cart currency:', CART_CURRENCY);

{% comment %} Fetch prices AND variant IDs from Shopify Admin {% endcomment %}
async function fetchPricesFromShopify() {
    console.log('=== FETCHING PRICES FROM SHOPIFY ADMIN ===');
    const productHandles = ['basic-bundle', 'premium-bundle'];

    for (const handle of productHandles) {
        try {
            const response = await fetch(`/products/${handle}.js`);
            if (response.ok) {
                const product = await response.json();

                console.log(`\n--- ${handle} ---`);
                console.log('Raw price (from API):', product.price);
                console.log('Cart currency:', CART_CURRENCY);

                if (product.variants && product.variants[0]) {
                    const variant = product.variants[0];

                    {% comment %} Store variant ID {% endcomment %}
                    if (handle === 'basic-bundle') {
                        window.SHOPIFY_VARIANT_BASIC = variant.id;
                    } else {
                        window.SHOPIFY_VARIANT_PREMIUM = variant.id;
                    }

                    {% comment %} Get price and convert to EUR {% endcomment %}
                    const priceInCartsCurrency = parseInt(variant.price);
                    const comparePriceInCartsCurrency = variant.compare_at_price ? parseInt(variant.compare_at_price) : 0;

                    console.log('Price in cart currency:', priceInCartsCurrency);

                    {% comment %} Get exchange rate from cart currency to EUR {% endcomment %}
                    const rateToEur = RATES_TO_EUR[CART_CURRENCY] || 1;
                    console.log(`Exchange rate: 1 EUR = ${rateToEur} ${CART_CURRENCY}`);
                    console.log(`Reverse rate: 1 ${CART_CURRENCY} = ${(1/rateToEur).toFixed(6)} EUR`);

                    {% comment %} Check if this is a zero-decimal currency {% endcomment %}
                    const isZeroDecimal = ZERO_DECIMAL_CURRENCIES.includes(CART_CURRENCY);

                    {% comment %} Convert to EUR {% endcomment %}
                    let priceEur, originalPriceEur;

                    if (CART_CURRENCY === 'EUR') {
                        {% comment %} Already in EUR {% endcomment %}
                        priceEur = isZeroDecimal ? priceInCartsCurrency : priceInCartsCurrency / 100;
                        originalPriceEur = isZeroDecimal ? comparePriceInCartsCurrency : comparePriceInCartsCurrency / 100;
                    } else {
                        {% comment %} Convert from cart currency to EUR {% endcomment %}
                        if (isZeroDecimal) {
                            {% comment %} Zero-decimal: HUF, JPY, etc. - price is already in whole units {% endcomment %}
                            priceEur = Math.round(priceInCartsCurrency / rateToEur);
                            originalPriceEur = comparePriceInCartsCurrency > 0 ? Math.round(comparePriceInCartsCurrency / rateToEur) : 0;
                        } else {
                            {% comment %} Decimal currency: Price from API is in cents, divide by 100 first {% endcomment %}
                            const priceInDecimal = priceInCartsCurrency / 100;
                            const comparePriceInDecimal = comparePriceInCartsCurrency > 0 ? comparePriceInCartsCurrency / 100 : 0;
                            priceEur = Math.round(priceInDecimal / rateToEur);
                            originalPriceEur = comparePriceInDecimal > 0 ? Math.round(comparePriceInDecimal / rateToEur) : 0;
                        }
                    }

                    console.log(`Final EUR price: ${priceEur}`);
                    console.log(`Original EUR price: ${originalPriceEur}`);

                    {% comment %} Store in DEFAULT_PRICES_EUR {% endcomment %}
                    DEFAULT_PRICES_EUR[handle] = {
                        price: priceEur,
                        original: originalPriceEur
                    };

                    console.log(`âœ… ${handle} updated:`, DEFAULT_PRICES_EUR[handle]);
                }
            } else {
                console.error(`Failed to fetch ${handle}:`, response.status);
            }
        } catch (error) {
            console.error(`Error fetching ${handle}:`, error);
        }
    }

    console.log('\n=== FINAL PRICES FROM SHOPIFY ADMIN ===');
    console.log('DEFAULT_PRICES_EUR:', JSON.stringify(DEFAULT_PRICES_EUR, null, 2));

    {% comment %} Re-render prices on page after fetch completes {% endcomment %}
    if (window.SHOPIFY_CURRENCY) {
        console.log('Re-rendering prices with currency:', window.SHOPIFY_CURRENCY);
        updatePricesWithCurrency(window.SHOPIFY_CURRENCY);
    }
}

// Exchange rates relative to EUR
const RATES_TO_EUR = {
    'EUR': 1, 'USD': 1.08, 'GBP': 0.86, 'CAD': 1.47,
    'AUD': 1.62, 'JPY': 162, 'PLN': 4.32, 'RON': 4.97,
    'HUF': 385, 'CZK': 25.3, 'SEK': 11.2, 'DKK': 7.45,
    'NOK': 11.4, 'BGN': 1.96, 'CHF': 0.94, 'TRY': 35.2,
    'BDT': 117,
    // Asian currencies
    'MYR': 4.55, 'THB': 37, 'VND': 27000, 'IDR': 16500,
    'PHP': 62, 'SGD': 1.45, 'INR': 90, 'PKR': 300,
    'LKR': 330, 'NPR': 145, 'CNY': 7.8, 'TWD': 34,
    'HKD': 8.4, 'KRW': 1450, 'BND': 1.45, 'KHR': 4400,
    'LAK': 24000, 'MMK': 23000, 'NZD': 1.75,
    // Middle East currencies
    'ILS': 4.0, 'AED': 4.0, 'SAR': 4.1, 'QAR': 4.0,
    'KWD': 0.34, 'OMR': 0.42, 'BHD': 0.41, 'JOD': 0.77,
    'LBP': 95000, 'EGP': 53, 'MAD': 11, 'DZD': 145,
    'TND': 34, 'LYD': 5.4, 'NGN': 1600, 'KES': 150,
    'GHS': 17, 'ZAR': 20, 'NAD': 20, 'BWP': 14.5,
    // Americas currencies
    'BRL': 5.4, 'ARS': 1100, 'MXN': 18, 'COP': 4500,
    'PEN': 4.0, 'CLP': 950, 'UYU': 42, 'PYG': 8000,
    'BOB': 7.5, 'CRC': 5600, 'GTQ': 8.5, 'HNL': 27,
    'NIO': 38, 'DOP': 63, 'JMD': 170, 'TTD': 7.3,
    'BBD': 2.2, 'BSD': 1.5, 'XCD': 4.0,
    // Russia and neighbors
    'RUB': 100, 'UAH': 42, 'BYN': 2.8, 'KZT': 470,
    'ISK': 150, 'MKD': 62, 'ALL': 105, 'BAM': 2.0
};

// Currency symbols
const CURRENCY_SYMBOLS = {
    'EUR': 'â‚¬', 'USD': '$', 'GBP': 'Â£', 'CAD': 'C$',
    'AUD': 'A$', 'JPY': 'Â¥', 'PLN': 'zÅ‚', 'RON': 'lei',
    'HUF': 'Ft', 'CZK': 'KÄ', 'SEK': 'kr', 'DKK': 'kr',
    'NOK': 'kr', 'BGN': 'Ð»Ð²', 'CHF': 'Fr', 'TRY': 'â‚º',
    'BDT': 'à§³',
    // Asian currencies
    'MYR': 'RM', 'THB': 'à¸¿', 'VND': 'â‚«', 'IDR': 'Rp',
    'PHP': 'â‚±', 'SGD': 'S$', 'INR': 'â‚¹', 'PKR': 'Rs',
    'LKR': 'Rs', 'NPR': 'Rs', 'CNY': 'Â¥', 'TWD': 'NT$',
    'HKD': 'HK$', 'KRW': 'â‚©', 'BND': 'B$', 'KHR': 'áŸ›',
    'LAK': 'â‚­', 'MMK': 'Ks', 'NZD': 'NZ$',
    // Middle East currencies
    'ILS': 'â‚ª', 'AED': 'Ø¯.Ø¥', 'SAR': 'ï·¼', 'QAR': 'ï·¼',
    'KWD': 'Ø¯.Ùƒ', 'OMR': 'Ø±.Ø¹.', 'BHD': 'BD', 'JOD': 'Ø¯.Ø§',
    'LBP': 'Ù„.Ù„', 'EGP': 'EÂ£', 'MAD': 'Ø¯.Ù….', 'DZD': 'Ø¯.Ø¬',
    'TND': 'Ø¯.Øª', 'LYD': 'Ù„.Ø¯', 'NGN': 'â‚¦', 'KES': 'KSh',
    'GHS': 'â‚µ', 'ZAR': 'R', 'NAD': 'N$', 'BWP': 'P',
    // Americas currencies
    'BRL': 'R$', 'ARS': '$', 'MXN': '$', 'COP': '$',
    'PEN': 'S/', 'CLP': '$', 'UYU': '$', 'PYG': 'â‚²',
    'BOB': 'Bs', 'CRC': 'â‚¡', 'GTQ': 'Q', 'HNL': 'L',
    'NIO': 'C$', 'DOP': 'RD$', 'JMD': 'J$', 'TTD': 'TT$',
    'BBD': 'Bds$', 'BSD': 'B$', 'XCD': 'EC$',
    // Russia and neighbors
    'RUB': 'â‚½', 'UAH': 'â‚´', 'BYN': 'Br', 'KZT': 'â‚¸',
    'ISK': 'kr', 'MKD': 'Ð´ÐµÐ½', 'ALL': 'L', 'BAM': 'KM'
};

// Convert price from EUR to target currency
function convertPriceFromEur(eurPrice, targetCurrency) {
    if (targetCurrency === 'EUR') return eurPrice;
    const rate = RATES_TO_EUR[targetCurrency] || 1;
    const converted = Math.round(eurPrice * rate);
    console.log(`convertPriceFromEur: ${eurPrice} EUR -> ${targetCurrency} (rate: ${rate}) = ${converted}`);
    return converted;
}

// Format price with currency symbol
function formatPrice(amount, currency) {
    const symbol = CURRENCY_SYMBOLS[currency] || currency + ' ';
    const formatted = symbol + Math.round(amount);
    console.log(`formatPrice: ${amount} ${currency} -> "${formatted}"`);
    return formatted;
}

// Update all prices on the page
function updatePricesWithCurrency(currency) {
    console.log('=== updatePricesWithCurrency called ===');
    console.log('Target currency:', currency);
    console.log('Exchange rate for this currency:', RATES_TO_EUR[currency]);

    document.querySelectorAll('[data-pricing-section]').forEach(container => {
        ['basic-bundle', 'premium-bundle'].forEach(bundleKey => {
            const priceEl = container.querySelector(`[data-product-pricing="${bundleKey}"] .data-price`);
            const originalEl = container.querySelector(`[data-product-pricing="${bundleKey}"] .data-original-price`);
            const discountEl = container.querySelector(`[data-product-pricing="${bundleKey}"] .data-discount-badge`);

            if (!priceEl) return;

            const defaults = DEFAULT_PRICES_EUR[bundleKey];
            console.log(`\n--- ${bundleKey} ---`);
            console.log('Original EUR price:', defaults.price);
            const convertedPrice = convertPriceFromEur(defaults.price, currency);
            const formattedPrice = formatPrice(convertedPrice, currency) + ' ';
            console.log('Final formatted price:', formattedPrice);

            priceEl.textContent = formattedPrice;

            if (originalEl) originalEl.style.display = 'none';
            if (discountEl) discountEl.style.display = 'none';
        });
    });

    // Update guarantee price
    const guaranteePriceEl = document.getElementById('guarantee-price');
    if (guaranteePriceEl) {
        const convertedPrice = convertPriceFromEur(DEFAULT_PRICES_EUR['premium-bundle'].price, currency);
        guaranteePriceEl.textContent = formatPrice(convertedPrice, currency);
    }
}

// Store the function globally so it can be called after API detection
window.updatePricesWithCurrency = updatePricesWithCurrency;

// Initialize currency system
window.SHOPIFY_CURRENCY_SYMBOL = "{{ cart.currency.symbol }}";
window.SHOPIFY_SHOP_URL = "{{ request.host }}";
window.SHOPIFY_BASE_CURRENCY = "{{ shop.currency }}";

// Detect country and initialize prices
(async function detectCountryAndInit() {
    let countryCode = "{{ request.country_code }}" || null;

    // First, fetch prices from Shopify Admin
    console.log('Fetching prices before initializing currency...');
    await fetchPricesFromShopify();

    // If Shopify detected country, use it
    if (countryCode && countryCode !== '' && countryCode !== 'null') {
        initCurrency(countryCode);
        return;
    }

    // Otherwise fetch from IP geolocation API
    try {
        const response = await fetch('https://ipapi.co/json/');
        const data = await response.json();
        countryCode = data.country_code;
        initCurrency(countryCode);
    } catch (error) {
        // Fallback to browser locale
        const locale = navigator.language || navigator.userLanguage || 'en-US';
        countryCode = locale.split('-')[1] || locale.toUpperCase();
        initCurrency(countryCode);
    }
})();

function initCurrency(countryCode) {
    console.log('\n=== initCurrency called ===');
    console.log('Detected country code:', countryCode);

    const detectedCurrency = countryToCurrency[countryCode] || 'EUR';
    const detectedFlag = countryCodeToFlag[countryCode] || 'ðŸŒ';
    const countryName = countryNames[countryCode] || countryCode;
    const currencySymbol = CURRENCY_SYMBOLS[detectedCurrency] || detectedCurrency + ' ';

    console.log('Detected currency:', detectedCurrency);
    console.log('Detected flag:', detectedFlag);
    console.log('Currency symbol:', currencySymbol);

    // Update global variables
    window.SHOPIFY_CURRENCY = detectedCurrency;
    window.VISITOR_COUNTRY = countryCode;
    window.VISITOR_FLAG = detectedFlag;

    // Calculate converted prices
    const basicPriceEur = DEFAULT_PRICES_EUR['basic-bundle'].price;
    const premiumPriceEur = DEFAULT_PRICES_EUR['premium-bundle'].price;
    console.log('Basic price (EUR base):', basicPriceEur);
    console.log('Premium price (EUR base):', premiumPriceEur);

    const basicPriceConverted = convertPriceFromEur(basicPriceEur, detectedCurrency);
    const premiumPriceConverted = convertPriceFromEur(premiumPriceEur, detectedCurrency);
    const basicPriceFormatted = formatPrice(basicPriceConverted, detectedCurrency);
    const premiumPriceFormatted = formatPrice(premiumPriceConverted, detectedCurrency);

    console.log('Basic converted & formatted:', basicPriceFormatted);
    console.log('Premium converted & formatted:', premiumPriceFormatted);

    // Update flag in hero
    const detectedFlagEl = document.querySelector('.detected-flag');
    if (detectedFlagEl) {
        detectedFlagEl.textContent = detectedFlag;
    }

    // Update prices with detected currency
    updatePricesWithCurrency(detectedCurrency);

    // Auto-select language based on country (fallback to English)
    const detectedLanguage = getLanguageForCountry(countryCode);
    console.log('Auto-selecting language:', detectedLanguage, 'for country:', countryCode);

    // Wait for translations.js to load, then switch language
    const switchLanguageInterval = setInterval(() => {
        if (typeof switchLanguage === 'function') {
            clearInterval(switchLanguageInterval);
            console.log('Calling switchLanguage with:', detectedLanguage);
            switchLanguage(detectedLanguage);

            // Update the dropdown display
            const languageCurrent = document.getElementById('language-current');
            const languageSelector = document.getElementById('language-selector');
            if (languageCurrent) {
                const selectedOption = document.querySelector(`.language-option[data-value="${detectedLanguage}"]`);
                if (selectedOption) {
                    languageCurrent.textContent = selectedOption.textContent;
                }
            }
            if (languageSelector) {
                languageSelector.value = detectedLanguage;
            }
        }
    }, 100);

    // Stop trying after 5 seconds
    setTimeout(() => clearInterval(switchLanguageInterval), 5000);
}
</script>
